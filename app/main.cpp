#include <EthStructures/EthComposite.h>
#include <ByteSet/TrieNode.h>
#include <curl/curl.h>
#include <nlohmann/json.hpp>

int main(int argc, char *argv[])
{
    ByteSet<BYTE> empty;
    cout << empty.RLPSerialize(false).keccak256().asString() << endl;
    cout << empty.RLPSerialize(true).keccak256().asString() << endl;
    
    //Block 1547723 (Hoodi)
    ByteSet block_rlp("0xf90e04f90277a01eb05e67097ae0c68b73431963743424e9bc8d2da20eb3bd87d8d314361f3390a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794dd11751cdd3f6eff01b1f6151b640685bfa5db4aa0a7d39c8dae3531da3eca6d0560ce4463064ad782eda2820526190bef86417de3a07459532742aecb6526b9e6a7af8890bdc247dd411df46eabf4156f2ce666b47ca07628feeec97bad383c116befecccf8cc4b6e0a5743e090f8be172c5590b24edeb901000000400000000040100000000000000081004000000200000000000000010002000080000100010000020000000001000001000000000000020800000000000060010014000000000020000c00000420010000000001000000001100000000000000000002000240040801000008080000000000000000008004001000000010000020200040000000000000000200000000000000000000000800000200000018040000000000008008010020002002000000200000a0000000100000108880100000020001000000024000008001000000000000401400000004001000200002000008000000000100120000100000804002000240000000000800040000008083179dcb8403938700831c721a846908ecd48b544f4f4c2076302e362e30a019539c12dca0726463529fff9ae268285e00b69e542badf2430a126f2f2ab211880000000000000000843fe8e61fa0c277b20309fa9bf2eb715aa056ca7ec22135136ca721cc6681ae2a1d6a241b3483080000840563f746a0eb2cb9679b405677c3109e02c331bd960fefd87d53df37a8bc422eae12657f22a0e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855f90953b902da02f902d683088bb082a84e847735940084f707603e830bf9989491cb447bafc6e0ea0f4fe056f5a9b1f14bb06e5d80b9026496051d56000000000000000000000000de68465dfca7ff708059ba948c31a872d01f6aba0000000000000000000000000000000000000000000000000000000000179dca47f1b1ab74edbdf3d96ab5ce084cd3141438ce9faa719deda6de91cccb54fa771eb05e67097ae0c68b73431963743424e9bc8d2da20eb3bd87d8d314361f339000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000002402ea2a60f8719ed0df1b24e8c6211e9baf8fa89ebac54027052cc7f9fb846e66a2b717dd287fe95288a096ab65379549295446dc08a7d4bf6dda9813e8ade66c701c18d1171bf542420bbe786ece560a4f80f982fbb7de983d272db821d28058807a87eb688dfd8652447324b24448d36aa54f7dc47f46aee044818d2e14e54b4059c69f44df7b67a7b5a18b679ed3301921d712c5ed71db739c4aa12611a1b3f2f86ff2d2799db489e6556353217baa277ad0377515c5a69c9585700c09ad58d1817beb6629409d571310aac498857942592581ec11270577b3dfd0a2b95db6427c2302607f2c5f446d716bb4085cbd521147f6a6306445fc57381097a42b93c00000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000c616369647261696e3632343300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c001a0d8e6922390d7d48a902eb1c3d85bd715351430639aa10b248c2073b6e7fe35dba06bb8cccd8615b46c6a063a276367fa8e4067cf7b82d09ca055662f273fffbb04b902da02f902d683088bb082a84f847735940084f707603e830ebe319491cb447bafc6e0ea0f4fe056f5a9b1f14bb06e5d80b9026496051d56000000000000000000000000328d6c70cd1ca8e45598aedcbe3683af02bb309f0000000000000000000000000000000000000000000000000000000000179dca56f4de2ccb6139c3cac95d46781f2342404bb2f2ca28e50e96a43248a4a4d9821eb05e67097ae0c68b73431963743424e9bc8d2da20eb3bd87d8d314361f339000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000002402ea2a60f8719ed0df1b24e8c6211e9baf8fa89ebac54027052cc7f9fb846e66a2b717dd287fe95288a096ab65379549295446dc08a7d4bf6dda9813e8ade66c701c18d1171bf542420bbe786ece560a4f80f982fbb7de983d272db821d28058807a87eb688dfd8652447324b24448d36aa54f7dc47f46aee044818d2e14e54b4059c69f44df7b67a7b5a18b679ed3301921d712c5ed71db739c4aa12611a1b3f2f86ff2d2799db489e6556353217baa277ad0377515c5a69c9585700c09ad58d251022595d1e7e78d08b9a788a518f6cb5389ae9e35b531f7cede608e5f294120230b685f64bc59e73a0eaac5850c84d1c61896557d53c8dc3335a5fbbb356d800000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000c616369647261696e3632343300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c001a064f707c839c3793340819ea7d0cf05bb7e44bcf1dc335397b09a2264983bc8e0a007818d70d1601216aff5bf0a986528cfcf47ea075df9ba65b481cb3ce53d58e8f8ac0684c8f4c0f28301b14194da38de6dba36918e716ade6a3ac7944d6a5d568380b844d0dbc83300000000000000000000000042cd2134256065f82355d60fb3b50faf0a7ad58a000000000000000000000000000000000000000000000000000000e8d4a5100083111784a03f00b65770a7b69c562857c87faf62f1030f5f3332427e5701b4dbb23a1256f6a00732169ab52ab1edea45a18d2ad1f3bcecc1f154d384c404646cba9113519917b89b03f89883088bb082067e84773594008505d21dba0082520894bc9aabe46838b2ee4df9478a4686da731943f23d8080c08504a817c800e1a001895828c34c7f6f6decd5798a3a09c0b8ee9b0d0f7e49d1d7340b1d3fa0f6ef01a0420ee05ca0650482dcc9f8b8796fc619b1110dc88b41c707dd0d336956787d44a05163b8c631946c46e0059c54f674b58e39323d4e91cc853837b47ad8ddb9a5d5b89b03f89883088bb08206ce84773594008505d21dba008252089453b344eef7db18321078d62bc8157a6ec4e0944f8080c08504a817c800e1a001dc6fe21305f425716f9d9d90321b2d62670f52b9d79e3f29bfe41201788e1701a0995bc2fc283ae83ba440914444a407cdb0d2c86ab16c1a8fe0d34610b3322ed3a005d61b3db89a95dc960dc657fbc6e551f81bca570c73fff959274682abb24785b89b03f89883088bb0820d2984773594008504a817c80082520894765c7e4917cd47048f35d92e5e28cf546a0277098080c08504a817c800e1a0015a908c6e86245029773071b85064c6868059b7e78fc37a19d6296132987a0501a04c85f8523b942b52460d00d0eca0969e3a030c1bda68443234136a755ecf3b1ea04c02a2f0f36dcb5c475a0a1a3c98d295616e089f9f672cfbadb1d2b3e9cab373b89b03f89883088bb08206e484773594008505d21dba0082520894ee0ff342d45b1731e2709bf8a14465316b6e6e608080c08504a817c800e1a0016bae7b55b8e763c10fab9ac6ac8424abfe9b77383820a59b119cd9ff70e13601a0bbb58f81c65fb3a9902cf7b0cee82a27f82c78cc16b118f5ab376f96bccff142a008f6c71b2064910716814e0e3cceeec415ceadcb63c4bfc6198574cd2c83621fb87502f87283088bb082848c80843fe8e61f8252089425941dc771bb64514fc8abbce970307fb9d477e9870d1834ff970be280c001a0350f6b1ea61ebdbbca303cd9f44271a5b6d922bf690d242b3ca6daeb5cc5b6c3a0299f3a7eed904a06fe20c5f89c54f332910eccb2aadf45c7f20d7b917ddeaebcc0f90230e2840177aeb3830d11ec94767f7576944d321374921df138589a30e3c5030d8330f3d8e2840177aeb4830d11ed94767f7576944d321374921df138589a30e3c5030d83312647e2840177aeb5830d11ee94767f7576944d321374921df138589a30e3c5030d83312ca0e2840177aeb6830d11ef94767f7576944d321374921df138589a30e3c5030d83314c2fe2840177aeb7830d11f094767f7576944d321374921df138589a30e3c5030d83309794e2840177aeb8830d11f194767f7576944d321374921df138589a30e3c5030d83311344e2840177aeb9830d11f294767f7576944d321374921df138589a30e3c5030d833080b3e2840177aeba830d11f394767f7576944d321374921df138589a30e3c5030d8330e216e2840177aebb830d11f494767f7576944d321374921df138589a30e3c5030d8330ce2be2840177aebc830d11f594767f7576944d321374921df138589a30e3c5030d83316114e2840177aebd830d11f694767f7576944d321374921df138589a30e3c5030d8330e770e2840177aebe830d11f794767f7576944d321374921df138589a30e3c5030d8331165de2840177aebf830d11f894767f7576944d321374921df138589a30e3c5030d833122eae2840177aec0830d11f994767f7576944d321374921df138589a30e3c5030d83315113e2840177aec1830d11fa94767f7576944d321374921df138589a30e3c5030d83310754e2840177aec2830d11fb94767f7576944d321374921df138589a30e3c5030d8330e9e7");
    ByteSet block_rlp1 = block_rlp;

    BlockChain bl;
    auto b = bl.newBlockFromRawRLP(block_rlp1);

    auto h = b->getHeader();
    auto f = h->get<Field>(0);
    cout << f->getValue() << endl;

    auto ws = b->getWithdrawals();
    auto w = ws->get<Withdrawal>(15);
    auto v = w->get<Field>(0);
    cout << v->getValue() << endl;

    ByteSet block_rlp2 = b->RLPSerialize();
    
    cout << "initial = " << hex << block_rlp.asString() << endl;
    cout << "final = " << hex << block_rlp2.asString() << endl;
    if(block_rlp2 == block_rlp)
        cout << "Yipee!!!" << endl;

    auto header_uncles_hash = h->get<Field>(1)->getValue();
    auto calculated_uncles_hash = b->getUncles()->RLPSerialize().keccak256();
    if(header_uncles_hash == calculated_uncles_hash)
        cout << "Yipee!!!" << endl;

    BlockTransactions Txs;
    auto tx0 = ByteSet("f8ab81a5852e90edd00083012bc294a3bed4e1c75d00fa6f4e5e6922db7261b5e9acd280b844a9059cbb0000000000000000000000008bda8b9823b8490e8cf220dc7b91d97da1c54e250000000000000000000000000000000000000000000000056bc75e2d6310000026a06c89b57113cf7da8aed7911310e03d49be5e40de0bd73af4c9c54726c478691ba056223f039fab98d47c71f84190cf285ce8fc7d9181d6769387e5efd0a970e2e9");
    auto tx1 = ByteSet("f8ab81a6852e90edd00083012bc294a3bed4e1c75d00fa6f4e5e6922db7261b5e9acd280b844a9059cbb0000000000000000000000008bda8b9823b8490e8cf220dc7b91d97da1c54e250000000000000000000000000000000000000000000000056bc75e2d6310000026a0d77c66153a661ecc986611dffda129e14528435ed3fd244c3afb0d434e9fd1c1a05ab202908bf6cbc9f57c595e6ef3229bce80a15cdf67487873e57cc7f5ad7c8a");
    auto tx2 = ByteSet("f86d8229f185199c82cc008252089488e9a2d38e66057e18545ce03b3ae9ce4fc360538702ce7de1537c008025a096e7a1d9683b205f697b4073a3e2f0d0ad42e708f03e899c61ed6a894a7f916aa05da238fbb96d41a4b5ec0338c86cfcb627d0aa8e556f21528e62f31c32f7e672");
    auto tx3 = ByteSet("f86f826b2585199c82cc0083015f9094e955ede0a3dbf651e2891356ecd0509c1edb8d9c8801051fdc4efdc0008025a02190f26e70a82d7f66354a13cda79b6af1aa808db768a787aeb348d425d7d0b3a06a82bd0518bc9b69dc551e20d772a1b06222edfc5d39b6973e4f4dc46ed8b196");
    Txs.create<BlockTransaction>(tx0);
    Txs.create<BlockTransaction>(tx1);
    Txs.create<BlockTransaction>(tx2);
    Txs.create<BlockTransaction>(tx3);

    cout << "0xab41f886be23cd786d8a69a72b0f988ea72e0b2e03970d0798f5e03763a442cc" << endl;

    SecureTrieNode<BlockTransaction> btt;
    for(uint i=0;i<Txs.getChildrenCount();i++) {
        ByteSet<NIBBLE> key(i);
        key.setRLPType(RLPType::INT);
        key = key.RLPSerialize(false);
        cout << "------------------------------- Transaction " << i << "------------------------------------" << endl;
        btt.store(key, *const_cast<BlockTransaction*>(Txs.get<Transaction>(i)));
        btt.printChildren();
    }

    cout << hex << btt.hash().asString() << endl;

    return 0;
}
